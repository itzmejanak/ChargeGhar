when you change .env file
-------------------------------------------------------------------------------
docker-compose up -d --force-recreate



docker-compose logs migrations --follow
docker-compose up -d migrations
docker-compose up -d
docker-compose build migrations
docker-compose run --rm migrations python manage.py makemigrations <appname>
docker-compose up migrations
docker-compose run --rm migrations python manage.py check
docker-compose run --rm migrations python manage.py check --deploy
docker-compose run --rm migrations python manage.py createsuperuser --username admin --email admin@example.com --noinput  
docker-compose up -d api
docker-compose logs api --tail=20
docker-compose ps
docker-compose restart api

docker-compose run --rm migrations python -c "import os; os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'api.config.settings'); import django; django.setup(); from django.contrib.auth import get_user_model; User = get_user_model(); user = User.objects.get(username='janak'); user.set_password('5060'); user.save(); print('Password set successfully')"
docker-compose run --rm migrations python manage.py flush --noinput


docker-compose run --rm migrations python manage.py shell -c "from api.stations.models import Station; print('Existing stations:'); [print(f'- {s.station_name} ({s.serial_number})') for s in Station.objects.all()]"
docker-compose run --rm migrations python manage.py shell -c "from api.stations.models import Station; [print(f'{s.station_name}: {s.id}') for s in Station.objects.all()]"
docker-compose run --rm migrations python manage.py 
shell -c "from api.stations.models import *; print('Amenities:', [a.name for a in StationAmenity.objects.all()]); print('Slots:', StationSlot.objects.count()); print('PowerBanks:', PowerBank.objects.count())"

docker-compose run --rm migrations python manage.py loaddata api/payments/fixtures/payments.json

docker-compose exec api python manage.py makemigrations points
docker-compose exec api python manage.py check --deploy
docker-compose exec api python manage.py spectacular --color --file schema.yml
docker-compose exec api uv sync

docker-compose uv run manage.py loaddata api/notifications/fixtures/notifications.json

docker-compose exec api python manage.py migrate



# Git Related Commands 

git branch --show-current
git branch -a
git diff --stat HEAD origin/rohan
git pull origin rohan
git push origin main







cd /opt/powerbank

# Stash local changes and pull latest
git stash
git pull origin main

# The script will now work perfectly
chmod +x deploy-production.sh
./deploy-production.sh






netstat -tlnp | grep :8010
docker ps --filter "publish=8010"

docker stop <container_id>
docker rm <container_id>

eg:
docker stop powerbank_local-powerbank_api-1
docker rm powerbank_local-powerbank_api-1




# Stop all containers except iotdemo ones
docker ps -q | grep -v "$(docker ps -qf name=iotdemo-app-prod)" | grep -v "$(docker ps -qf name=iotdemo-redis-prod)" | xargs -r docker stop

# Remove all stopped containers
docker ps -a -q | grep -v "$(docker ps -qf name=iotdemo-app-prod)" | grep -v "$(docker ps -qf name=iotdemo-redis-prod)" | xargs -r docker rm


docker image prune -a
docker ps
docker images


cd /opt/powerbank

# Stash local changes and pull latest
git stash
git pull origin main

# The script will now work perfectly
chmod +x deploy-production.sh
./deploy-production.sh




üîß To Check if Fixtures Loaded:
# Check if data exists in database
docker-compose -f docker-compose.prod.yml exec powerbank_api python manage.py shell -c "
from django.contrib.auth import get_user_model
User = get_user_model()
print(f'Users: {User.objects.count()}')

from api.stations.models import Station
print(f'Stations: {Station.objects.count()}')
"

docker-compose exec api python manage.py spectacular --color --file openapi-schema.json

docker-compose exec api python manage.py shell -c "from django.db import connection; cursor = connection.cursor(); cursor.execute('SELECT table_name FROM information_schema.tables WHERE table_schema = %s', ['public']); print([row[0] for row in cursor.fetchall()])"



docker exec powerbank_production-powerbank_api-1 python manage.py shell -c " # Clear the account lock (django-axes) from axes.models import AccessAttempt AccessAttempt.objects.filter(username='janak').delete() print('‚úÖ Account lock cleared for janak') # Set password for admin user from django.contrib.auth import get_user_model User = get_user_model() admin_user = User.objects.get(username='janak') admin_user.set_password('PowerBank@2024') admin_user.save() print('‚úÖ Password set for admin user') print('üåê Django Admin: https://main.chargeghar.com/admin/') print('üë§ Username: janak') print('üîë Password: PowerBank@2024') print('') print('üìß Email (for OTP): janak@powerbank.com') print('üîê OTP flow still works for API authentication') "





docker exec powerbank_local_api_1 python manage.py shell -c "
# Clear ALL axes locks for the admin user
from axes.models import AccessAttempt, AccessLog
from django.contrib.auth import get_user_model

# Clear by username
AccessAttempt.objects.filter(username='janak').delete()
AccessLog.objects.filter(username='janak').delete()

# Clear by email (in case it's locked by email)
AccessAttempt.objects.filter(username='janak@powerbank.com').delete()
AccessLog.objects.filter(username='janak@powerbank.com').delete()

# Clear by IP (if locked by IP)
AccessAttempt.objects.all().delete()
AccessLog.objects.all().delete()

print('‚úÖ All axes locks cleared')

# Verify admin user exists and has password
User = get_user_model()
try:
    admin_user = User.objects.get(username='janak')
    print(f'‚úÖ Admin user found: {admin_user.username}')
    print(f'   Email: {admin_user.email}')
    print(f'   Is staff: {admin_user.is_staff}')
    print(f'   Is superuser: {admin_user.is_superuser}')
    print(f'   Has usable password: {admin_user.has_usable_password()}')
    
    # Set password again to be sure
    admin_user.set_password('PowerBank@2024')
    admin_user.save()
    print('‚úÖ Password reset successfully')
    
except User.DoesNotExist:
    print('‚ùå Admin user not found')
"


curl -s https://raw.githubusercontent.com/polymorphisma/nepal-gateways/main/README.md
curl -s https://raw.githubusercontent.com/polymorphisma/nepal-gateways/main/docs/EsewaClient.md
curl -s https://raw.githubusercontent.com/polymorphisma/nepal-gateways/main/docs/KhaltiClient.md

python3 -m venv /tmp/nepal_env && /tmp/nepal_env/bin/pip install nepal-gateways==0.2.0
/tmp/nepal_env/bin/python -c "import nepal_gateways; print(nepal_gateways.__file__)"
/tmp/nepal_env/lib/python3.12/site-packages/nepal_gateways/__init__.py
find /tmp/nepal_env/lib/python3.12/site-packages/nepal_gateways -name "*.py" | head -10
cat /tmp/nepal_env/lib/python3.12/site-packages/nepal_gateways/__init__.py
cat /tmp/nepal_env/lib/python3.12/site-packages/nepal_gateways/esewa/client.py
cat /tmp/nepal_env/lib/python3.12/site-packages/nepal_gateways/khalti/client.py
cat /tmp/nepal_env/lib/python3.12/site-packages/nepal_gateways/esewa/config.py
cat /tmp/nepal_env/lib/python3.12/site-packages/nepal_gateways/core/base.py


scp firebase-credentials.json root@213.210.21.113:/opt/powerbank/

 docker cp test_social_system.py powerbank_local_api_1:/application/test_social.py


docker-compose exec api python manage.py shell -c "
from django.core.management import execute_from_command_line
from django.db import connection
from django.apps import apps

print('üóëÔ∏è  Dropping all data from PostgreSQL database...')
print('=' * 50)

# Get all models
all_models = apps.get_models()

# Get table names
table_names = []
for model in all_models:
    table_name = model._meta.db_table
    table_names.append(table_name)

print(f'Found {len(table_names)} tables to clear')

# Clear data using DELETE (safer than TRUNCATE for PostgreSQL with foreign keys)
with connection.cursor() as cursor:
    for model in all_models:
        table_name = model._meta.db_table
        try:
            cursor.execute(f'DELETE FROM {table_name};')
            print(f'‚úÖ Cleared: {table_name}')
        except Exception as e:
            print(f'‚ö†Ô∏è  Could not clear {table_name}: {e}')

print('\\nüéâ Database cleared successfully!')
"

cd /opt/powerbank
docker-compose -f docker-compose.prod.yml logs > latest_full_logs.txt 2>&1

cd /opt/iotdemo
docker-compose logs > iotdemo_full_logs.txt 2>&1

In LOcal Terminal
scp root@213.210.21.113:/opt/powerbank/latest_full_logs.txt ~/Downloads/
scp root@213.210.21.113:/opt/iotdemo/iotdemo_full_logs.txt ~/Downloads/

sudo systemctl stop valkey-server

docker-compose exec api python tests/test_rental_flows.py start-prepaid --email testuser@example.com

docker-compose exec api python tests/test_postpaid_balance.py


docker-compose exec api python manage.py shell -c "
from api.rentals.models import Rental

# Cancel all active rentals
active_rentals = Rental.objects.filter(status='ACTIVE')
count = active_rentals.count()

for rental in active_rentals:
    rental.status = 'CANCELLED'
    rental.save()
    print(f'Cancelled rental: {rental.rental_code}')

print(f'\n‚úÖ Cancelled {count} active rental(s)')
"


docker-compose exec api python manage.py shell -c "
from decimal import Decimal
from api.users.models import User
from api.rentals.models import RentalPackage
from api.rentals.services import RentalService
from api.stations.models import Station, PowerBank, StationSlot
from api.system.models import AppConfig

print('='*80)
print('POSTPAID MINIMUM BALANCE TEST')
print('='*80)

# Setup powerbank
station = Station.objects.first()
slot = StationSlot.objects.filter(station=station).first()
if slot:
    slot.battery_level = 100
    slot.status = 'AVAILABLE'
    slot.save()

powerbank = PowerBank.objects.filter(current_station=station).first()
if powerbank:
    powerbank.battery_level = 100
    powerbank.status = 'AVAILABLE'
    powerbank.current_slot = slot
    powerbank.save()
    print(f'‚úÖ Setup powerbank: {powerbank.serial_number} at 100%\n')

# Check config
config = AppConfig.objects.get(key='POSTPAID_MINIMUM_BALANCE')
print(f'Config: POSTPAID_MINIMUM_BALANCE = NPR {config.value}\n')

# Get POSTPAID package
postpaid = RentalPackage.objects.filter(payment_model='POSTPAID', is_active=True).first()
if not postpaid:
    postpaid = RentalPackage.objects.create(
        name='Test POSTPAID 1hr',
        duration_minutes=60,
        price=Decimal('50.00'),
        payment_model='POSTPAID',
        is_active=True
    )
print(f'Package: {postpaid.name} ({postpaid.payment_model})\n')

# Test 1: User with sufficient balance
print('TEST 1: User with sufficient balance (>= NPR 50)')
print('-' * 80)
user1 = User.objects.filter(wallet__balance__gte=50, is_active=True).first()
if user1:
    balance = user1.wallet.balance
    print(f'User: {user1.email}')
    print(f'Balance: NPR {balance}')
    
    service = RentalService()
    try:
        # This should pass the balance check
        service._validate_postpaid_balance(user1)
        print('‚úÖ Balance check PASSED (expected)\n')
    except Exception as e:
        print(f'‚ùå Balance check FAILED (unexpected): {e}\n')

# Test 2: User with insufficient balance
print('TEST 2: User with insufficient balance (< NPR 50)')
print('-' * 80)
user2 = User.objects.filter(wallet__balance__lt=50, wallet__balance__gte=0, is_active=True).first()
if not user2:
    # Create one
    from api.payments.models import Wallet
    user2 = User.objects.create_user(
        username='test_low_bal',
        email='test_low_bal@test.com',
        password='test123'
    )
    Wallet.objects.create(user=user2, balance=Decimal('20.00'))

balance = user2.wallet.balance if hasattr(user2, 'wallet') and user2.wallet else Decimal('0')
print(f'User: {user2.email}')
print(f'Balance: NPR {balance}')

service = RentalService()
try:
    service._validate_postpaid_balance(user2)
    print('‚ùå Balance check PASSED (unexpected - should have failed)\n')
except Exception as e:
    if 'insufficient_postpaid_balance' in str(e).lower() or 'minimum wallet balance' in str(e).lower():
        print(f'‚úÖ Balance check FAILED (expected): {e}\n')
    else:
        print(f'‚ö†Ô∏è  Balance check FAILED with unexpected error: {e}\n')

print('='*80)
print('POSTPAID BALANCE CHECK WORKING CORRECTLY!')
print('='*80)
"


docker exec -it powerbank_production-powerbank_api-1 python manage.py shell -c "from axes.models import AccessAttempt; AccessAttempt.objects.all().delete(); print('‚úÖ All login lockouts cleared.')"
