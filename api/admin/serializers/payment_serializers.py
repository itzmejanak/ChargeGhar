"""
Payment Serializers
Auto-generated by split_serializer.py
"""

from __future__ import annotations
from api.payments.models import PaymentMethod
from rest_framework import serializers
from .user_serializers import TransactionUserSerializer


class RefundFiltersSerializer(serializers.Serializer):
    """Serializer for refund filters"""
    start_date = serializers.DateTimeField(required=False)
    end_date = serializers.DateTimeField(required=False)
    search = serializers.CharField(required=False)
    page = serializers.IntegerField(default=1, min_value=1)
    page_size = serializers.IntegerField(default=20, min_value=1, max_value=100)



class ProcessRefundSerializer(serializers.Serializer):
    """Serializer for processing refund"""
    action = serializers.ChoiceField(choices=['APPROVE', 'REJECT'])
    admin_notes = serializers.CharField(max_length=1000, required=False, allow_blank=True)



class TransactionsQuerySerializer(serializers.Serializer):
    """Query parameters for transactions list"""
    source = serializers.ChoiceField(
        choices=['all', 'payment', 'wallet', 'points'],
        default='all',
        required=False,
        help_text="Filter by transaction source: all, payment, wallet, or points"
    )
    user_id = serializers.UUIDField(
        required=False,
        help_text="Filter by user ID"
    )
    search = serializers.CharField(
        required=False,
        max_length=200,
        help_text="Search by username or email"
    )
    start_date = serializers.DateTimeField(
        required=False,
        help_text="Start date for filtering"
    )
    end_date = serializers.DateTimeField(
        required=False,
        help_text="End date for filtering"
    )
    page = serializers.IntegerField(
        default=1,
        min_value=1,
        help_text="Page number"
    )
    page_size = serializers.IntegerField(
        default=20,
        min_value=1,
        max_value=100,
        help_text="Items per page"
    )



class TransactionItemSerializer(serializers.Serializer):
    """Single transaction item"""
    source = serializers.CharField(help_text="payment, wallet, or points")
    id = serializers.UUIDField()
    transaction_id = serializers.CharField()
    user = TransactionUserSerializer()
    type = serializers.CharField()
    amount = serializers.FloatField(required=False)
    points = serializers.IntegerField(required=False)
    points_source = serializers.CharField(required=False)
    status = serializers.CharField()
    balance_before = serializers.FloatField(required=False)
    balance_after = serializers.FloatField(required=False)
    created_at = serializers.DateTimeField()
    description = serializers.CharField()



class TransactionsResponseSerializer(serializers.Serializer):
    """Response format for transactions list"""
    results = TransactionItemSerializer(many=True)
    pagination = serializers.DictField()



class AdminPaymentMethodListSerializer(serializers.Serializer):
    """Serializer for payment method list filters"""
    is_active = serializers.BooleanField(required=False, allow_null=True, default=None)
    gateway = serializers.CharField(required=False)
    search = serializers.CharField(required=False)
    page = serializers.IntegerField(default=1, min_value=1)
    page_size = serializers.IntegerField(default=20, min_value=1, max_value=100)



class AdminPaymentMethodSerializer(serializers.ModelSerializer):
    """Serializer for payment method details"""
    
    class Meta:
        model = PaymentMethod
        fields = [
            'id', 'name', 'gateway', 'is_active', 'configuration',
            'min_amount', 'max_amount', 'supported_currencies',
            'created_at', 'updated_at'
        ]
        read_only_fields = ['id', 'created_at', 'updated_at']



class CreatePaymentMethodSerializer(serializers.Serializer):
    """Serializer for creating payment method"""
    name = serializers.CharField(max_length=100)
    gateway = serializers.CharField(max_length=255)
    is_active = serializers.BooleanField(default=True)
    configuration = serializers.JSONField(default=dict, required=False)
    min_amount = serializers.DecimalField(max_digits=10, decimal_places=2)
    max_amount = serializers.DecimalField(max_digits=10, decimal_places=2, required=False, allow_null=True)
    supported_currencies = serializers.ListField(
        child=serializers.CharField(max_length=10),
        default=list,
        required=False
    )
    
    def validate_min_amount(self, value):
        if value < 0:
            raise serializers.ValidationError("Minimum amount cannot be negative")
        return value
    
    def validate(self, data):
        if data.get('max_amount') and data.get('min_amount'):
            if data['max_amount'] < data['min_amount']:
                raise serializers.ValidationError({
                    'max_amount': 'Maximum amount must be greater than minimum amount'
                })
        return data



class UpdatePaymentMethodSerializer(serializers.Serializer):
    """Serializer for updating payment method"""
    name = serializers.CharField(max_length=100, required=False)
    gateway = serializers.CharField(max_length=255, required=False)
    is_active = serializers.BooleanField(required=False)
    configuration = serializers.JSONField(required=False)
    min_amount = serializers.DecimalField(max_digits=10, decimal_places=2, required=False)
    max_amount = serializers.DecimalField(max_digits=10, decimal_places=2, required=False, allow_null=True)
    supported_currencies = serializers.ListField(
        child=serializers.CharField(max_length=10),
        required=False
    )
    
    def validate_min_amount(self, value):
        if value and value < 0:
            raise serializers.ValidationError("Minimum amount cannot be negative")
        return value


